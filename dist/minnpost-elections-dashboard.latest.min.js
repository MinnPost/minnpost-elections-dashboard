/*! MinnPost Elections Dashboard - LATEST VERSION - 2014-08-12
* https://github.com/zzolo/minnpost-elections-dashboard
* Copyright (c) 2014 MinnPost; Licensed MIT */

define("helpers",["jquery","underscore","backbone","mpFormatters"],function(a,b,c,d){var e={},f={};return e.overrideBackboneAJAX=function(){c.ajax=function(){var a,e=arguments;return e[0].dataTypeForce!==!0&&(a=d.hash(e[0].url),f[a]=b.isUndefined(f[a])?0:f[a]+1,e[0].dataType="jsonp",e[0].jsonpCallback="mpServerSideCachingHelper"+a+f[a]),c.$.ajax.apply(c.$,e)}},e.isMSIE=function(){var a=/(msie) ([\w.]+)/i.exec(navigator.userAgent);return a?parseInt(a[2],10):!1},e.jsonpRequest=function(c){var e=c;return e.dataTypeForce!==!0&&(hash=d.hash(e.url),f[hash]=b.isUndefined(f[hash])?0:f[hash]+1,e.dataType="jsonp",e.jsonpCallback="mpServerSideCachingHelper"+hash+f[hash]),a.ajax.apply(a,[e])},e.getLocalData=function(c,d){var f=!1,g=[];return c=b.isArray(c)?c:[c],d&&d.paths&&0===d.paths.data.indexOf("http")&&(f=!0),b.each(c,function(b){var c;c=f?e.jsonpRequest({url:proxyPrefix+encodeURI(d.paths.data+b)},d):a.getJSON(d.paths.data+b),g.push(c)}),a.when.apply(a,g)},e.parseQueryString=function(){var a={},c=function(a){return decodeURIComponent(a.replace(/\+/g," "))},d=location.search.substring(1),e=d.split("&");return b.each(e,function(b){var d=b.split("=");d.length>1&&(a[c(d[0])]=c(d[1]))}),a},e}),define("models",["jquery","underscore","backbone","moment","moment-timezone","helpers"],function(a,b,c,d,e,f){var g={};return g.ContestModel=c.Model.extend({query:"SELECT r.*, c.* FROM contests AS c LEFT JOIN results AS r ON c.id = r.contest_id WHERE c.id = '%CONTEST_ID%' ORDER BY r.percentage ASC, r.candidate",contestFields:["id","contest_id","boundary","county_id","district_code","office_id","precinct_id","precincts_reporting","question_body","ranked_choice","results_group","seats","state","title","total_effected_precincts","total_votes_for_office","updated","question_body","question_help","primary","scope","partisan"],npParties:["NP","WI"],initialize:function(a,b){this.options=b||{},this.app=b.app,this.on("sync",this.contestUpdate)},url:function(){return this.app.options.electionsAPI+encodeURIComponent(this.query.replace("%CONTEST_ID%",this.id))},parse:function(a,c){var e=this,f={},g=!1;if(f.results=[],c.collection)return a;if(b.each(a,function(a){var c={};b.each(a,function(a,d){b.indexOf(e.contestFields,d)>=0?f[d]=a:c[d]=a}),f.results.push(c)}),f.ranked_choice){var h={};b.each(f.results,function(a){var c=a.ranked_choice_place;h[a.candidate_id]=h[a.candidate_id]||{},h[a.candidate_id].ranked_choices=h[a.candidate_id].ranked_choices||{},h[a.candidate_id].ranked_choices[c]={ranked_choice:c,percentage:a.percentage,votes_candidate:a.votes_candidate,office_name:a.office_name},1===c&&(h[a.candidate_id]=b.extend(h[a.candidate_id],a)),100===c&&(h[a.candidate_id].percentage=a.percentage,h[a.candidate_id].votes_candidate=a.votes_candidate)}),f.results=b.values(h)}return f.results=b.sortBy(f.results,"candidate"),f.results=b.sortBy(f.results,function(a){return-1*a.percentage}),f.primary&&(f.results=b.sortBy(f.results,"party_id")),f.done=f.precincts_reporting===f.total_effected_precincts,f.ranked_choice&&(g=b.size(f.results)==b.size(b.filter(f.results,function(a){return!b.isUndefined(a.ranked_choices[100])}))),f.done&&!f.ranked_choice&&!f.primary||f.done&&f.ranked_choice&&g&&!f.primary||f.done&&f.primary&&!f.partisan?(f.results=b.map(f.results,function(a,b){return a.winner=!1,b<f.seats&&(a.winner=!0),a}),f.final=!0):f.done&&f.primary&&f.partisan&&(b.each(b.groupBy(f.results,"party_id"),function(a){b.each(a,function(a,b){return a.winner=!1,b<f.seats&&(a.winner=!0),a})}),f.final=!0),f.updated=d.unix(f.updated),f},contestUpdate:function(){this.set("synced",!0),!this.get("fetchedBoundary")&&b.isString(this.get("boundary"))&&this.fetchBoundary()},fetchBoundary:function(){var a=this;f.jsonpRequest({url:this.app.options.boundaryAPI+"boundary/?limit=10&slug__in="+encodeURIComponent(this.get("boundary"))},this.app.options).done(function(c){b.isArray(c.objects)&&(a.set("boundarySets",c.objects),a.set("fetchedBoundary",!0))})},connect:function(a){var b=this;this.set("fetchedBoundary",a!==!1?!1:!0),this.fetch(),this.pollID=window.setInterval(function(){b.fetch()},this.app.options.electionsAPIPollInterval)},disconnect:function(){window.clearInterval(this.pollID)}}),g.ElectionModel=c.Model.extend({query:"SELECT * FROM swvariables",initialize:function(a,b){this.options=b||{},this.app=b.app},url:function(){return this.app.options.electionsAPI+encodeURIComponent(this.query)},parse:function(a){var c,e,f={};return b.each(a,function(a){f[a.name]="integer"===a.type?parseInt(a.value_blob,10):"float"===a.type?parseFloat(a.value_blob):"boolean"===a.type?!!a.value_blob:a.value_blob}),f.date&&(f.date=d(f.date)),f.updated&&(f.updated=d.unix(f.updated)),f.isTest=!1,f.date&&(c=d().tz("America/Chicago"),e=f.date.clone(),e.tz("America/Chicago").hour(15).minute(0),c.isBefore(e,"minute")&&(f.isTest=!0)),f},connect:function(){var a=this;this.fetch(),this.pollID=window.setInterval(function(){a.fetch()},this.app.options.electionsAPIPollInterval)},disconnect:function(){window.clearInterval(this.pollID)}}),g}),define("collections",["jquery","underscore","backbone","models","helpers"],function(a,b,c,d,e){var f={};return f.ContestsCollection=c.Collection.extend({model:d.ContestModel,query:"SELECT r.*, c.* FROM contests AS c LEFT JOIN results AS r ON c.id = r.contest_id WHERE (%CONTEST_SEARCH%) ORDER BY c.title, r.percentage, r.candidate ASC LIMIT 400",url:function(){var a=this.options.search.split("|");return a=b.map(a,function(a){return a=a.split(" ").join("%"),a=a.split("+").join("%"),"title LIKE '%"+a+"%'"}),this.app.options.electionsAPI+encodeURIComponent(this.query.replace("%CONTEST_SEARCH%",a.join(" OR ")))},parse:function(a){var c=b.map(b.values(b.groupBy(a,"id")),this.model.prototype.parse,this.model.prototype);return c},initialize:function(a,b){this.options=b||{},this.app=b.app,this.on("add",function(a){a.options=b,a.app=b.app}),this.on("sync",function(){this.contestUpdate()})},contestUpdate:function(){this.fetchedBoundary||this.fetchBoundary()},fetchBoundary:function(){var a=this;e.jsonpRequest({url:this.app.options.boundaryAPI+"boundary/?limit=30&slug__in="+encodeURIComponent(this.pluck("boundary").join(","))},this.app.options).done(function(c){b.isArray(c.objects)&&(b.each(c.objects,function(c){b.each(a.filter(function(a){return a.get("boundary").indexOf(c.slug)>=0}),function(a){a.set("boundarySets",[c])})}),a.fetchedBoundary=!0,a.each(function(a){a.set("fetchedBoundary",!0)}))})},connect:function(){var a=this,b={collection:!0};this.fetch(b),this.pollID=window.setInterval(function(){a.fetch(b)},this.app.options.electionsAPIPollInterval)},disconnect:function(){window.clearInterval(this.pollID)}}),f.ContestsLocationCollection=f.ContestsCollection.extend({query:"SELECT r.*, c.* FROM contests AS c LEFT JOIN results AS r ON c.id = r.contest_id WHERE boundary IN (%CONTEST_SEARCH%) ORDER BY c.title, r.percentage, r.candidate ASC LIMIT 400",url:function(){return this.app.options.electionsAPI+encodeURIComponent(this.query.replace("%CONTEST_SEARCH%","'"+this.boundaries.join("','")+"'"))},initialize:function(){f.ContestsLocationCollection.__super__.initialize.apply(this,arguments),this.on("fetchedBoundary",function(){this.connect()})},contestUpdate:function(){this.matchedBoundary||this.matchBoundary()},matchBoundary:function(){var a=this;b.each(this.fullBoundaries,function(c){b.each(a.where({boundary:c.slug}),function(a){a.set("boundarySets",[c])})}),this.each(function(a){a.set("fetchedBoundary",!0)}),this.matchedBoundary=!0},fetchBoundaryFromCoordinates:function(){var a=this;e.jsonpRequest({url:this.app.options.boundaryAPI+"boundary/?contains="+encodeURIComponent(this.options.lonlat[1])+","+encodeURIComponent(this.options.lonlat[0])+"&sets="+encodeURIComponent(this.app.options.boundarySets.join(","))},this.app.options).done(function(c){b.isArray(c.objects)&&(a.fullBoundaries=c.objects,a.boundaries=b.pluck(c.objects,"slug"),a.trigger("fetchedBoundary"))})}}),f}),define("text!templates/application.mustache",[],function(){return'<div class="message-container"></div>\n\n<div class="content-container"></div>\n\n<div class="footnote-container"></div>'}),define("text!templates/footnote.mustache",[],function(){return'<div class="footnote">\n  <p>Unofficial election data provided by the <a href="http://www.sos.state.mn.us/" target="_blank">MN Secretary of State</a>.  For ranked-choice contests data is supplemented manually from the <a href="http://vote.minneapolismn.gov/" target="_blank">City of Minneapolis</a> and the <a href="http://www.stpaul.gov/index.aspx?NID=188" target="_blank">City of St. Paul</a>.  Test data will be provided until 8PM on Election Night.</p>\n\n  <p>The geographical boundaries, though received from official sources and queried from our <a href="http://boundaries.minnpost.com" target="_blank">boundary service</a>, may not represent the exact, offical area for a contest, race, or election.  It is also possible that for a given location the contests may not be accurate due to data quality with multiple agencies.  Please refer to your local and state election officials to know exactly what contests happen for a given location.</p>\n\n  <p>Some map data © OpenStreetMap contributors; licensed under the <a href="http://www.openstreetmap.org/copyright" target="_blank">Open Data Commons Open Database License</a>.  Some map design © MapBox; licensed according to the <a href="http://mapbox.com/tos/" target="_blank">MapBox Terms of Service</a>.  Location geocoding provided by <a href="http://www.mapquest.com/" target="_blank">Mapquest</a> and is not guaranteed to be accurate.</p>\n\n  <p>Some code, techniques, and data on <a href="https://github.com/minnpost/minnpost-elections-dashboard" target="_blank">Github</a>.</p>\n</div>\n'}),define("text!templates/contest.mustache",[],function(){return'<div class="contest {{#isDashboard}}dashboard-contest{{/isDashboard}} {{ classes }} {{#(ranked_choice == 1)}}is-ranked-choice {{/()}}{{#(final === true)}}is-final{{/()}} {{#primary}}primary{{/primary}}">\n  {{^isDashboard}}\n    <a class="dashboard-link" href="#dashboard">&larr; Back to dashboard</a>\n  {{/isDashboard}}\n\n  <div>\n    {{#((results.length == 0 || results == undefined) && !synced)}}\n      {{>loading}}\n    {{/()}}\n  </div>\n\n  {{#((results.length == 0 || results == undefined) && synced)}}\n    <h3>Did not find any contests</h3>\n  {{/()}}\n\n\n  {{#((results.length > 0) && synced)}}\n    <h3>\n      {{ title }}\n      {{#(show_party != undefined)}}<span class="show-party party-label bg-color-political-{{ show_party.toLowerCase() }}" title="{{ parties[show_party.toLowerCase()] }}">{{ show_party }}</span>{{/()}}\n    </h3>\n\n    {{^isDashboard}}\n      <div class="last-updated">Last updated at {{ updated.format(\'h:mm a\') }}</div>\n    {{/isDashboard}}\n\n    {{#(!!question_body)}}\n      <p>{{{ question_body }}}</p>\n    {{/()}}\n  {{/()}}\n\n  <div class="{{^isDashboard}}row{{/isDashboard}}">\n    <div class="{{^isDashboard}}column-medium-70 inner-column-left{{/isDashboard}}">\n      <div class="">\n        <table class="striped">\n          <thead>\n            <tr class="table-first-heading">\n              <th class="winner-column"></th>\n              <th>Candidate</th>\n              {{#(partisan && show_party === undefined)}}\n                <th>\n                  <span class="large-table-label">Party</span>\n                  <span class="small-table-label"></span>\n                </th>\n              {{/()}}\n              {{#(ranked_choice == 1)}}\n                <th class="first-choice-column">Results</th>\n                <th class="second-choice-column"></th>\n                <th class="third-choice-column"></th>\n                <th class="final-column">Final</th>\n              {{/()}}\n              {{#(ranked_choice != 1)}}\n                {{^isDashboard}}\n                  <th class="percentage">\n                    <span class="large-table-label">Percentage</span>\n                    <span class="small-table-label">%</span>\n                  </th>\n                  <th class="votes">Votes</th>\n                {{/isDashboard}}\n                {{#isDashboard}}\n                  <th class="percentage">Results</th>\n                {{/isDashboard}}\n              {{/()}}\n            </tr>\n            <tr class="table-second-heading">\n              <th class="winner-column"></th>\n              <th>{{ precincts_reporting }} of {{ total_effected_precincts }} precincts reporting.  {{#(seats > 1)}}Choosing {{ seats }}.{{/()}}</th>\n              {{#(partisan && show_party === undefined)}}\n                <th></th>\n              {{/()}}\n              {{#(ranked_choice == 1)}}\n                <th class="first-choice-column first-choice-heading">1st choice</th>\n                <th class="second-choice-column second-choice-heading">2nd choice</th>\n                <th class="third-choice-column third-choice-heading">3rd choice</th>\n                <th class="final-column"></th>\n              {{/()}}\n              {{#(ranked_choice != 1)}}\n                <th></th>\n                {{^isDashboard}}\n                  <th></th>\n                {{/isDashboard}}\n              {{/()}}\n            </tr>\n          </thead>\n\n          <tbody>\n            {{#results:r}} {{#(!isDashboard || ((show_party == undefined && (r < 2 || (rows != undefined && r < rows))) || (show_party != undefined && party_id == show_party)))}}\n              <tr data-row-id="{{ id }}" class="{{ (r % 2 === 0) ? \'even\' : \'odd\' }} {{#primary}}{{ party_id.toLowerCase() }}{{/primary}}">\n                <td class="winner-column">{{#winner}}<span class="fa fa-check"></span>{{/winner}}</td>\n\n                <td class="candidate-column">{{ candidate }}</td>\n\n                {{#(partisan && show_party === undefined)}}\n                  <td><span class="party-label bg-color-political-{{ party_id.toLowerCase() }}" title="{{ parties[party_id.toLowerCase()] }}">{{ party_id }}</span></td>\n                {{/()}}\n\n                {{#(ranked_choice == 1)}}\n                  <td class="first-choice-column first-choice-heading">{{ formatters.number(ranked_choices.1.percentage) }}% ({{ formatters.number(ranked_choices.1.votes_candidate, 0) }}&nbsp;votes)</td>\n                  <td class="second-choice-column first-choice-heading">{{ formatters.number(ranked_choices.2.percentage) }}% ({{ formatters.number(ranked_choices.2.votes_candidate, 0) }}&nbsp;votes)</td>\n                  <td class="third-choice-column first-choice-heading">{{ formatters.number(ranked_choices.3.percentage) }}% ({{ formatters.number(ranked_choices.3.votes_candidate, 0) }}&nbsp;votes)</td>\n                  <td class="final-column first-choice-heading">{{#ranked_choices.100.percentage}}{{ formatters.number(ranked_choices.100.percentage) }}% ({{ formatters.number(ranked_choices.100.votes_candidate, 0) }}&nbsp;votes){{/ranked_choices.100.percentage}}{{^ranked_choices.100.percentage}}&mdash;{{/ranked_choices.100.percentage}}</td>\n                {{/()}}\n\n                {{#(ranked_choice != 1)}}\n                  <td class="percentage">{{ formatters.number(percentage) }}%</td>\n                  {{^isDashboard}}\n                    <td class="votes">{{ formatters.number(votes_candidate, 0) }}</td>\n                  {{/isDashboard}}\n                {{/()}}\n              </tr>\n            {{/()}} {{/results}}\n          </tbody>\n        </table>\n      </div>\n\n      <a href="#contest/{{ id }}" class="contest-link">{{#isDashboard}}Full results{{/isDashboard}}{{^isDashboard}}Permalink{{/isDashboard}}</a>\n    </div>\n\n    {{^isDashboard}}\n      <div class="column-medium-30 inner-column-right">\n        <div class="contest-map" id="contest-map-{{ id }}"></div>\n      </div>\n    {{/isDashboard}}\n  </div>\n</div>\n'}),define("text!templates/contests.mustache",[],function(){return'<div class="contests">\n  <a class="dashboard-link" href="#dashboard">&larr; Back to dashboard</a>\n\n  <div class="row">\n    <div class="column-medium-70 inner-column-left contests-title-section">\n      <h2 class="contests-title {{#(lonlat != undefined)}}with-location{{/()}}">{{ (title) ? title : \'Contests\' }}</h2>\n\n      <p class="caption">\n        Found\n          {{#(models.length == 0 && !synced)}}\n            <i class="loading small"></i>\n          {{/())}}\n          {{#synced}}\n            {{ models.length }}\n          {{/synced}}\n        results.\n      </p>\n\n      {{#(lonlat != undefined)}}\n        <p class="caption">The map below shows the approximate location of your search. If the location is not correct, try <a href="#dashboard">searching for a more specific address</a>.</p>\n\n        <div id="location-map"></div>\n      {{/())}}\n    </div>\n\n    <div class="column-medium-30 inner-column-right"></div>\n  </div>\n\n  <div>\n    {{#(models.length == 0 && !synced)}}\n      {{>loading}}\n    {{/())}}\n\n    {{#(models.length == 0 && synced)}}\n      <p class="large">Unable to find any contests.</p>\n    {{/())}}\n  </div>\n\n  <div class="contest-list">\n    {{#models:i}}\n      {{>contest}}\n    {{/models}}\n  </div>\n</div>\n'}),define("text!templates/dashboard.mustache",[],function(){return'<div class="dashboard {{ classes }}">\n\n  <div class="location-search-section">\n    <form role="form" class="" on-submit="addresssSearch">\n\n      <div class="location-search-group">\n        <div class="form-input-group">\n          <label for="address" class="sr-only">Search address for results</label>\n          <input type="text" id="address-search" placeholder="Search address for results">\n\n          <div class="button-group">\n            <button type="submit" class="button primary address-search-submit">Search</button>\n          </div>\n        </div>\n      </div>\n\n      {{#geolocationEnabled}}\n        <div class="geolocation">\n          <a href="#location">Or view contests at your current location <i class="fa fa-location-arrow"></i></a>\n        </div>\n      {{/geolocationEnabled}}\n    </form>\n  </div>\n\n  <div class="last-updated-section">\n    <div>\n      {{#election.date}}\n        {{ election.date.format(\'MMM DD, YYYY\') }} {{ (election.primary) ? \'primary\' : \'general\' }} election {{#election.isTest}}<em>test</em>{{/election.isTest}} results.\n      {{/election.date}}\n      {{#election.updated}}\n        Last updated at {{ election.updated.format(\'h:mm a\') }}\n      {{/election.updated}}\n    </div>\n  </div>\n\n  <div class="row">\n    <div class="column-medium-50">\n      <div class="inner-column-left">\n\n        <div class="contest-governor-r dashboard-section">\n          {{#contestGovernorR}}\n            {{>contest}}\n          {{/contestGovernorR}}\n        </div>\n\n        <div class="contest-auditor-dfl dashboard-section">\n          {{#contestAuditorDFL}}\n            {{>contest}}\n          {{/contestAuditorDFL}}\n        </div>\n\n        <div class="elections-search dashboard-section">\n          <h4>Other elections</h4>\n          {{>electionsSearch}}\n        </div>\n      </div>\n    </div>\n\n    <div class="column-medium-50">\n      <div class="inner-column-right">\n\n        <div class="contest-senate-r dashboard-section">\n          {{#contestSenateR}}\n            {{>contest}}\n          {{/contestSenateR}}\n        </div>\n\n        <div class="contest-house-60b-dfl dashboard-section">\n          {{#contestHouse60BDFL}}\n            {{>contest}}\n          {{/contestHouse60BDFL}}\n        </div>\n\n        <div class="contest-house-48b-r dashboard-section">\n          {{#contestHouse48BR}}\n            {{>contest}}\n          {{/contestHouse48BR}}\n        </div>\n\n        <div class="elections-search dashboard-section">\n          <h4>Other elections</h4>\n          {{>electionsSearch}}\n        </div>\n\n      </div>\n    </div>\n  </div>\n</div>\n'}),define("text!templates/loading.mustache",[],function(){return'<div class="loading-container">\n  <i class="loading"></i> Loading...\n</div> \n'}),define("text!templates/elections-search-form.mustache",[],function(){return'<form role="form" class="" on-submit="contestSearch">\n\n  <p class="caption" for="contest-search">{{#capabilities.typeahead}}Search contests by title or candidate.  Start typing to see suggestions for specific contests, or search by {{/capabilities.typeahead}}{{^capabilities.typeahead}}Search contests by title with {{/capabilities.typeahead}} keywords (e.g., "<a href="#search/state+representative">state representative</a>" or "<a href="#search/school+board">school board</a>").</p>\n\n  <div class="form-input-group">\n    <input type="text" class="contest-search" placeholder="Search by title{{#capabilities.typeahead}} or candidate{{/capabilities.typeahead}}" />\n\n    <div class="button-group">\n      <button type="submit" class="button primary contest-search-submit">Search</button>\n    </div>\n  </div>\n</form>\n'}),define("views",["jquery","underscore","backbone","ractive","ractive-events-tap","ractive-backbone","leaflet","models","collections","bloodhound","typeahead-js","placeholders-js","mpConfig","mpFormatters","text!templates/application.mustache","text!templates/footnote.mustache","text!templates/contest.mustache","text!templates/contests.mustache","text!templates/dashboard.mustache","text!templates/loading.mustache","text!templates/elections-search-form.mustache"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u){var v={};return v.highlightDecorator=function(b){return{update:function(){var c=a(b);c.removeClass("unhighlight"),c.addClass("highlight"),setTimeout(function(){c.addClass("unhighlight")},200)},teardown:function(){}}},d.decorators.highlight=v.highlightDecorator,v.ApplicationView=d.extend({init:function(){this.set("parties",m.politicalParties)},template:o}),v.FootnoteView=d.extend({init:function(){},template:p}),v.ContestBaseView=d.extend({defaultMapStyle:{stroke:!0,color:"#2DA51D",weight:1.5,opacity:.9,fill:!0,fillColor:"#2DA51D",fillOpacity:.2,clickable:!1},adapt:["Backbone"],makeMap:function(a,c){var d,e,f,h=this,i={};c=b.isArray(c)?c:[c],c=b.filter(c,function(a){return b.isUndefined(i[a.slug])?(i[a.slug]=!0,!0):!1}),e=b.map(c,function(a){return a.simple_shape}),f=new g.Map(a,{zoom:10,center:[44.98,-93.2636],scrollWheelZoom:!1,trackResize:!0,zoomControl:!1,dragging:!1}),f.addControl(new g.Control.Zoom({position:"topright"})),f.attributionControl.setPrefix(!1),f.addLayer(new g.tileLayer("//{s}.tiles.mapbox.com/v3/minnpost.map-wi88b700/{z}/{x}/{y}.png")),d=new g.featureGroup,b.each(e,function(a){var b=new g.geoJson(a);b.setStyle(h.defaultMapStyle),d.addLayer(b)}),f.addLayer(d),window.setTimeout(function(){f.fitBounds(d.getBounds())},500)},observeTitle:function(a){this.observe("title",function(b){b&&(document.title=a?b+" | "+a:b)})}}),v.DashboardView=v.ContestBaseView.extend({template:s,partials:{contest:q,loading:t,electionsSearch:u},init:function(c){var d,e,f=this,g=a(this.el).find(".contest-search");this.app=c.app,this.set("formatters",n),this.set("parties",m.politicalParties),this.app.options.capabilities.typeahead&&(d=this.app.options.electionsAPI+"SELECT c.id AS id, title AS title FROM contests AS c WHERE c.title LIKE '%%QUERY%' UNION SELECT c.id AS id, r.candidate || ' (' || c.title || ')' AS title FROM results AS r JOIN contests AS c ON r.contest_id = c.id WHERE r.candidate LIKE '%%QUERY%' ORDER BY title LIMIT 20 ",e=new j({name:"Contests and Candidates",datumTokenizer:j.tokenizers.obj.whitespace("title"),queryTokenizer:j.tokenizers.whitespace,remote:{url:d,replace:function(a,b){var c=decodeURIComponent(b);return c=c.replace(new RegExp(" ","g"),"%"),encodeURI(a.replace(new RegExp(this.wildcard,"g"),c))},ajax:{dataType:"jsonp",jsonpCallback:"mpServerSideCachingHelper"}}}),e.initialize(),g.each(function(){a(this).typeahead(null,{displayKey:"title",source:e.ttAdapter(),minLength:3,hint:!0,highlight:!0}),a(this).on("typeahead:selected",function(a,b){f.app.router.navigate("/contest/"+b.id,{trigger:!0})})}),this.on("teardown",function(){g.typeahead("destroy")})),this.set("geolocationEnabled",b.isObject(navigator)&&b.isObject(navigator.geolocation))}}),v.ContestView=v.ContestBaseView.extend({template:q,partials:{loading:t},init:function(){this.set("classes","contest-view"),this.set("formatters",n),this.set("parties",m.politicalParties),this.observe("boundarySets",function(a){b.isArray(a)&&b.isObject(a[0])&&this.makeMap("contest-map-"+this.get("id"),a)})}}),v.ContestsView=v.ContestBaseView.extend({template:r,partials:{contest:q,loading:t},init:function(){var a=this,c={};this.set("formatters",n),this.set("parties",m.politicalParties),this.observe("models.*.boundarySets",function(a,d,e){var f=e.split("."),g=this.get(f[0]+"."+f[1]);b.isArray(a)&&b.isObject(a[0])&&b.isObject(g)&&!c[g.get("id")]&&(c[g.get("id")]=!0,this.makeMap("contest-map-"+g.get("id"),a))}),this.data.models.on("sync",function(){a.set("synced",!0)}),this.observe("lonlat",function(a){var c,d,e=a;b.isArray(e)&&b.isNumber(e[0])&&(c=new g.Map("location-map",{zoom:13,center:[e[1],e[0]],scrollWheelZoom:!1,trackResize:!0,zoomControl:!1,dragging:!1}),c.attributionControl.setPrefix(!1),c.addLayer(new g.tileLayer("//{s}.tiles.mapbox.com/v3/minnpost.map-wi88b700/{z}/{x}/{y}.png")),d=new g.circleMarker([e[1],e[0]],10),d.setStyle(this.defaultMapStyle),c.addLayer(d))})}}),v}),define("routers",["jquery","underscore","backbone","models","collections","views"],function(a,b,c,d,e,f){var g={};return g.DashboardRouter=c.Router.extend({initialize:function(a){this.options=a,this.app=a.app},routes:{dashboard:"routeDashboard","search/:term":"routeSearch","contest/:contest":"routeContest","location(/:place)":"routeLocation","*default":"routeDefault"},start:function(){c.history.start()},routeDefault:function(){this.navigate("/dashboard",{trigger:!0,replace:!0})},routeDashboard:function(){var c=this,e={};this.teardownObjects(),this.app.dashboardContests={contestGovernorR:"id-MN----0331",contestAuditorDFL:"id-MN----0333",contestSenateR:"id-MN----0102",contestHouse60BDFL:"id-MN---60B-0307",contestHouse48BR:"id-MN---48B-0283"},b.each(this.app.dashboardContests,function(a,b){c.app[b]=new d.ContestModel({id:a},{app:c.app}),c.app[b].connect(!1),c.app[b].set("isDashboard",!0),e[b]=c.app[b]}),e.contestGovernorR.set("show_party","R"),e.contestAuditorDFL.set("show_party","DFL"),e.contestSenateR.set("show_party","R"),e.contestHouse60BDFL.set("show_party","DFL"),e.contestHouse48BR.set("show_party","R"),this.app.election=new d.ElectionModel({},{app:this.app}),e.election=this.app.election,this.app.election.connect(),e.capabilities=c.app.options.capabilities,e.title="Dashboard",this.app.dashboardView=new f.DashboardView({el:this.app.$el.find(".content-container"),data:e,app:this.app}),this.app.dashboardView.on("addresssSearch",function(b){var d=a(this.el).find("#address-search").val();b.original.preventDefault(),d&&c.navigate("/location/"+encodeURIComponent(d),{trigger:!0})}),this.app.dashboardView.on("contestSearch",function(b){b.original.preventDefault();var d=a(b.node).find(".contest-search.tt-input"),e=d.val();e&&c.navigate("/search/"+encodeURIComponent(e),{trigger:!0})}),this.app.dashboardView.observeTitle(this.app.options.originalTitle),this.reFocus()},routeSearch:function(a){this.teardownObjects(),this.app.contestsSearch=new e.ContestsCollection([],{app:this.app,search:a}),this.app.contestsSearch.connect(),this.app.contestsSearchView=new f.ContestsView({el:this.app.$el.find(".content-container"),data:{models:this.app.contestsSearch,title:'Search for "'+a.replace(/\+/g," ")+'"'}}),this.app.contestsSearchView.observeTitle(this.app.options.originalTitle),this.reFocus()},routeContest:function(a){this.teardownObjects(),this.app.contest=new d.ContestModel({id:a},{app:this.app}),this.app.contest.connect(),this.app.contestView=new f.ContestView({el:this.app.$el.find(".content-container"),data:this.app.contest}),this.app.contestView.observeTitle(this.app.options.originalTitle),this.reFocus()},routeLocation:function(a){function c(b){d.app.locationContests=new e.ContestsLocationCollection([],{app:d.app,lonlat:b}),d.app.locationContests.fetchBoundaryFromCoordinates(),d.app.contestsLocationView=new f.ContestsView({el:d.app.$el.find(".content-container"),data:{models:d.app.locationContests,title:a?'Contests for "'+a+'"':"Contests for your location",lonlat:b}}),d.app.contestsLocationView.observeTitle(d.app.options.originalTitle),d.reFocus()}var d=this;this.teardownObjects(),a?/[a-zA-Z]+/.test(a)||b.isNaN(parseFloat(a.split(",")[0]))||b.isNaN(parseFloat(a.split(",")[1]))?this.addressLocate(a).done(function(a){c(a)}):c([parseFloat(a.split(",")[0]),parseFloat(a.split(",")[1])]):this.geolocate().done(function(a){c(a)})},geolocate:function(){var b=this,c=a.Deferred();return navigator.geolocation.getCurrentPosition(function(a){c.resolveWith(b,[[a.coords.longitude,a.coords.latitude]])},function(){c.rejectWith(b,[{message:"Issue retrieving current position."}])}),c.promise()},addressLocate:function(c){var d=this,e=a.Deferred(),f=this.app.options.mapQuestQuery.replace("[[[KEY]]]",this.app.options.mapQuestKey).replace("[[[ADDRESS]]]",encodeURIComponent(c));return a.ajax({dataType:"jsonp",url:f}).done(function(a){var c;b.size(a.results[0].locations)>0&&b.isObject(a.results[0].locations[0].latLng)?(c=a.results[0].locations[0].latLng,e.resolveWith(d,[[c.lng,c.lat]])):e.rejectWith(d,[{message:"Issue retrieving position from address."}])}).fail(function(){e.rejectWith(d,arguments)}),e.promise()},reFocus:function(){this.viewed&&a("html, body").animate({scrollTop:this.app.$el.offset().top-5},750),this.viewed=!0},teardownObjects:function(){var a=this,c=["contestView","contestsSearchView","contestsLocationView"],d=["contest","contestsSearch","locationContests","election"];b.isObject(this.app.dashboardContests)&&(d=b.union(d,b.keys(this.app.dashboardContests))),b.each(d,function(c){b.isObject(a.app[c])&&(a.app[c].stopListening(),a.app[c].disconnect())}),b.each(c,function(c){b.isObject(a.app[c])&&(b.isObject(a.app[c].map),a.app[c].teardown(),delete a.app[c])})}}),g}),define("minnpost-elections-dashboard",["jquery","underscore","ractive","mpConfig","mpFormatters","helpers","views","routers"],function(a,b,c,d,e,f,g,h){var i=function(c){this.options=b.extend(this.defaultOptions,c),this.el=this.options.el,this.$el=a(this.el),this.$=function(a){return this.$el.find(a)},this.$content=this.$el.find(".content-container"),this.loadApp()};return b.extend(i.prototype,{start:function(){var c=this;f.overrideBackboneAJAX(),this.applicationView=new g.ApplicationView({el:this.$el}),c.footnoteView=new g.FootnoteView({el:this.$el.find(".footnote-container")}),this.router=new h.DashboardRouter(b.extend(this.options,{app:this})),this.router.start(),this.options.capabilities.preventLinks&&a('a[href^="#"]').on("click",this.$el,function(b){b.preventDefault(),c.router.navigate(a(this).attr("href"),{trigger:!0})})},defaultOptions:{projectName:"minnpost-elections-dashboard",remoteProxy:"//mp-jsonproxy.herokuapp.com/proxy?callback=?&url=",el:".minnpost-elections-dashboard-container",electionsAPIPollInterval:5e4,electionsAPI:"//50.19.100.197/?box=ubuntu&method=sql&q=",electionsAPILocal:"//localhost:5000/?q=",electionsAPIEC2:"//50.19.100.197/?box=ubuntu&method=sql&q=",electionsAPIScraperWiki:"//premium.scraperwiki.com/ez47yoa/aaff8e67f921428/sql/?q=",boundaryAPI:"//boundaries.minnpost.com/1.0/",boundarySets:["counties-2010","minor-civil-divisions-2010","school-districts-2013","wards-2012","state-house-districts-2012","state-senate-districts-2012","minnesota-state-2014","district-courts-2012"],mapQuestKey:"Fmjtd%7Cluur20a7n0%2C8n%3Do5-9a1s9f",mapQuestQuery:"//open.mapquestapi.com/geocoding/v1/address?key=[[[KEY]]]&outFormat=json&countrycodes=us&maxResults=1&location=[[[ADDRESS]]]",originalTitle:document.title,capabilities:{typeahead:!0,preventLinks:!f.isMSIE()&&f.isMSIE()<=9},availablePaths:{local:{css:[".tmp/css/main.css"],images:"images/",data:"data/"},build:{css:["//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css","dist/minnpost-elections-dashboard.libs.min.css","dist/minnpost-elections-dashboard.latest.min.css"],ie:["dist/minnpost-elections-dashboard.libs.min.ie.css","dist/minnpost-elections-dashboard.latest.min.ie.css"],images:"dist/images/",data:"dist/data/"},deploy:{css:["//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css","//s3.amazonaws.com/data.minnpost/projects/minnpost-elections-dashboard/minnpost-elections-dashboard.libs.min.css","//s3.amazonaws.com/data.minnpost/projects/minnpost-elections-dashboard/minnpost-elections-dashboard.latest.min.css"],ie:["//s3.amazonaws.com/data.minnpost/projects/minnpost-elections-dashboard/minnpost-elections-dashboard.libs.min.ie.css","//s3.amazonaws.com/data.minnpost/projects/minnpost-elections-dashboard/minnpost-elections-dashboard.latest.min.ie.css"],images:"//s3.amazonaws.com/data.minnpost/projects/minnpost-elections-dashboard/images/",data:"//s3.amazonaws.com/data.minnpost/projects/minnpost-elections-dashboard/data/"}}},loadApp:function(){this.determinePaths(),this.getLocalAssests(function(a){this.renderAssests(a),this.start()
})},determinePaths:function(){var a;this.options.deployment="deploy",-1!==window.location.host.indexOf("localhost")&&(this.options.deployment="local",a=f.parseQueryString(),b.isObject(a)&&b.isString(a.mpDeployment)&&(this.options.deployment=a.mpDeployment)),this.options.paths=this.options.availablePaths[this.options.deployment]},getLocalAssests:function(b){var c=this;"local"===this.options.deployment?a.getJSON("bower.json",function(a){b.apply(c,[a.dependencyMap])}):b.apply(this,[])},renderAssests:function(c){var d=f.isMSIE()&&f.isMSIE()<=8;b.isObject(c)&&b.each(c,function(c){c.css&&b.each(c.css,function(b){b=b.match(/^(http|\/\/)/)?b:"bower_components/"+b+".css",a("head").append('<link rel="stylesheet" href="'+b+'" type="text/css" />')}),c.ie&&d&&b.each(c.ie,function(b){b=b.match(/^(http|\/\/)/)?b:"bower_components/"+b+".css",a("head").append('<link rel="stylesheet" href="'+b+'" type="text/css" />')})}),b.each(this.options.paths.css,function(b){a("head").append('<link rel="stylesheet" href="'+b+'" type="text/css" />')}),d&&b.each(this.options.paths.ie,function(b){a("head").append('<link rel="stylesheet" href="'+b+'" type="text/css" />')}),this.$el.addClass("processed")}}),i}),require(["jquery","minnpost-elections-dashboard"],function(a,b){a(document).ready(function(){new b})});