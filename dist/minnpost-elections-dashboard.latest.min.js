/*! MinnPost Elections Dashboard - v0.0.1 - 2013-11-04
* https://github.com/zzolo/minnpost-elections-dashboard
* Copyright (c) 2013 MinnPost; Licensed MIT */

var mpApps=mpApps||{},mpTemplates=mpTemplates||{};mpTemplates["minnpost-elections-dashboard"]=mpTemplates["minnpost-elections-dashboard"]||{},_.mixin({formatNumber:function(a,b){b=_.isUndefined(b)?2:b;var c=/(\d+)(\d{3})/;for(split=a.toFixed(b).toString().split(".");c.test(split[0]);)split[0]=split[0].replace(c,"$1,$2");return b?split[0]+"."+split[1]:split[0]},formatCurrency:function(a){return"$"+_.formatNumber(a,2)},formatPercent:function(a){return _.formatNumber(100*a,1)+"%"},formatPercentChange:function(a){return(a>0?"+":"")+_.formatPercent(a)},hash:function(a){return Math.abs(_.reduce(a.split(""),function(a,b){return a=(a<<5)-a+b.charCodeAt(0),a&a},0))}}),Backbone.ajax=function(){var a=arguments;return a[0].dataTypeForce!==!0&&(a[0].dataType="jsonp",a[0].jsonpCallback="mpServerSideCachingHelper"+_.hash(a[0].url)),Backbone.$.ajax.apply(Backbone.$,a)},function(a){App=mpApps["minnpost-elections-dashboard"]=function(b){this.options=_.extend(this.defaultOptions,b),this.$el=a(this.options.el),this.templates=mpTemplates["minnpost-elections-dashboard"]||{},this.data=this.data||{}},_.extend(App.prototype,{extend:Backbone.Model.extend,jsonpRequest:function(){var b=arguments[0];return b.dataType="jsonp",b.jsonpCallback="mpServerSideCachingHelper"+_.hash(b.url),a.ajax.apply(a,[b])},getTemplates:function(b){var c=this,d=[];return b=_.isArray(b)?b:[b],_.each(b,function(b){var e,f="js/templates/"+b+".mustache";_.isUndefined(c.templates[b])&&(e=a.ajax({url:f,method:"GET",async:!1,contentType:"text"}),a.when(e).done(function(a){c.templates[b]=a}),d.push(e))}),a.when.apply(a,d)},template:function(a){return this.templates[a]},getLocalData:function(b){var c=this,d=this.options.jsonpProxy,e=!1,f=[];return b=_.isArray(b)?b:[b],this.options&&0===this.options.dataPath.indexOf("http")&&(e=!0),_.each(b,function(b){var g;_.isUndefined(c.data[b])&&(g=e?this.jsonpRequest({url:d+encodeURI(c.options.dataPath+b+".json")}):a.getJSON(c.options.dataPath+b+".json"),a.when(g).done(function(a){c.data[b]=a}),f.push(g))}),a.when.apply(a,f)},getRemoteData:function(b){return b.dataType="jsonp",this.options.remoteProxy&&(b.url=b.url+"&callback=proxied_jqjsp",b.url=app.options.remoteProxy+encodeURIComponent(b.url),b.callback="proxied_jqjsp",b.cache=!0),a.ajax(b)},start:function(){}})}(jQuery),mpTemplates=mpTemplates||{},mpTemplates["minnpost-elections-dashboard"]={"template-application":'<div class="message-container"></div>\n\n<div class="content-container"></div>\n\n<div class="footnote-container"></div>',"template-contest":'<div class="contest {{ classes }}">\n  <a class="dashboard-link" href="#dashboard">&larr; Back to dashboard</a>\n\n  <div>\n    {{#(results.length == 0 || results == undefined)}}\n      {{>loading}}\n    {{/())}}\n  </div>\n\n  <h3>{{ title }}</h3>\n\n  <div class="last-updated">Last updated at {{ updated.format(\'h:mm a\') }}</div>\n\n  {{#question_body}}\n    <p>{{{ question_body }}}</p>\n  {{/question_body}}\n\n  <div class="grid-container grid-parent cf">\n    <div class="grid-70 tablet-grid-70 mobile-grid-100 grid-parent inner-column-left">\n      <table>\n        <thead>\n          <tr class="table-first-heading">\n            <th>Candidate</th>\n            {{#partisan}}\n              <th>Party</th>\n            {{/partisan}}\n            {{#(ranked_choice == 1)}}\n              <th>Results</th>\n              <th></th>\n              <th></th>\n              <th>Final</th>\n            {{/()}}\n            {{#(ranked_choice != 1)}}\n              <th>Percentage</th>\n              <th>Votes</th>\n            {{/()}}\n          </tr>\n          <tr class="table-second-heading">\n            <th>{{ precincts_reporting }} of {{ total_effected_precincts }} precincts reporting.  {{#(seats > 1)}}Choosing {{ seats }}.{{/()}}</th>\n            {{#partisan}}\n              <th></th>\n            {{/partisan}}\n            {{#(ranked_choice == 1)}}\n              <th class="first-choice-heading">1st choice</th>\n              <th class="second-choice-heading">2nd choice</th>\n              <th class="third-choice-heading">3rd choice</th>\n              <th></th>\n            {{/()}}\n            {{#(ranked_choice != 1)}}\n              <th></th>\n              <th></th>\n            {{/()}}\n          </tr>\n        </thead>\n\n        <tbody>\n          {{#results:r}}\n            <tr data-row-id="{{ id }}" class="{{ (r % 2 === 0) ? \'even\' : \'odd\' }}">\n              <td>{{#winner}}Y{{/winner}}{{#(winner === false)}}N{{/()}} {{ candidate }}</td>\n\n              {{#partisan}}\n                <td>{{ party_id }}</td>\n              {{/partisan}}\n\n              {{#(ranked_choice == 1)}}\n                <td>{{ fNum(ranked_choices.1.percentage) }}% ({{ fNum(ranked_choices.1.votes_candidate, 0) }} votes)</td>\n                <td>{{ fNum(ranked_choices.2.percentage) }}% ({{ fNum(ranked_choices.2.votes_candidate, 0) }} votes)</td>\n                <td>{{ fNum(ranked_choices.3.percentage) }}% ({{ fNum(ranked_choices.3.votes_candidate, 0) }} votes)</td>\n                <td>{{#ranked_choices.100.percentage}}{{ fNum(ranked_choices.100.percentage) }}% ({{ fNum(ranked_choices.100.votes_candidate, 0) }} votes){{/ranked_choices.100.percentage}}{{^ranked_choices.100.percentage}}&mdash;{{/ranked_choices.100.percentage}}</td>\n              {{/()}}\n\n              {{#(ranked_choice != 1)}}\n                <td>{{ fNum(percentage) }}%</td>\n                <td>{{ fNum(votes_candidate, 0) }}</td>\n              {{/()}}\n            </tr>\n          {{/results}}\n        </tbody>\n      </table>\n\n      <a href="#contest/{{ id }}" class="contest-link">Link to contest</a>\n    </div>\n\n    <div class="grid-30 tablet-grid-30 mobile-grid-100 grid-parent inner-column-right">\n      <div class="contest-map" id="contest-map-{{ id }}">\n      </div>\n    </div>\n  </div>\n\n</div>',"template-contests":'<div class="contests">\n  <a class="dashboard-link" href="#dashboard">&larr; Back to dashboard</a>\n\n  <h3 class="contests-title">{{ (title) ? title : \'Contests\' }}</h3>\n\n  <div>\n    {{#(models.length == 0)}}\n      {{>loading}}\n    {{/())}}\n  </div>\n\n  <div class="contest-list">\n    {{#models:i}}\n      {{>contest}}\n    {{/models}}\n  </div>\n</div>',"template-dashboard-contest":'<div class="dashboard-contest {{ .classes }}">\n  <div>\n    {{#(results.length == 0 || results == undefined)}}\n      {{>loading}}\n    {{/())}}\n  </div>\n\n  <h4>{{ .title }}</h4>\n\n  <table>\n    <thead>\n      <tr class="table-first-heading">\n        <th>Candidate</th>\n        {{#(ranked_choice == 1)}}\n          <th>Round One</th>\n          <th>Final</th>\n        {{/()}}\n        {{#(ranked_choice != 1)}}\n          <th>Results</th>\n        {{/()}}\n      </tr>\n      <tr class="table-second-heading">\n        <th>{{ precincts_reporting }} of {{ total_effected_precincts }} precincts reporting</th>\n        {{#(ranked_choice == 1)}}\n          <th class="first-choice-heading">1st choice</th>\n        {{/()}}\n        <th></th>\n      </tr>\n    </thead>\n\n    <tbody>\n      {{#results:r}}{{#(r < 2 || (rows != undefined && r < rows))}}\n        <tr class="{{ (r % 2 === 0) ? \'even\' : \'odd\' }}">\n          <td>{{#winner}}Y{{/winner}}{{#(winner === false)}}N{{/()}} {{ candidate }}</td>\n\n          {{#(ranked_choice == 1)}}\n            <td>{{ fNum(ranked_choices.1.percentage) }}% ({{ fNum(votes_candidate, 0) }} votes)</td>\n            <td>{{#ranked_choices.100.percentage}}{{ fNum(ranked_choices.100.percentage) }}% ({{ fNum(ranked_choices.100.votes_candidate, 0) }} votes){{/ranked_choices.100.percentage}}{{^ranked_choices.100.percentage}}&mdash;{{/ranked_choices.100.percentage}}</td>\n          {{/()}}\n\n          {{#(ranked_choice != 1)}}\n            <td>{{ fNum(percentage) }}% ({{ fNum(votes_candidate, 0) }} votes)</td>\n          {{/()}}\n        </tr>\n      {{/()}}{{/results}}\n    </tbody>\n  </table>\n\n  <a href="#contest/{{ id }}" class="contest-link">Full results</a>\n</div>',"template-dashboard":'<div class="dashboard cf grid-container grid-parent {{ classes }}">\n\n  <div class="grid-parent grid-100 location-search-section">\n      <form on-submit="addresssSearch">\n        <div class="location-search-group">\n          <input type="text" id="address-search" placeholder="Search election results by address" />\n\n          {{#geolocationEnabled}}\n            <div class="geolocation">\n              <a href="#location">Or view contests at your current location</a>\n            </div>\n          {{/geolocationEnabled}}\n        </div>\n\n        <input type="submit" value="Go" class="address-search-submit" on-submit="addresssSearch" />\n      </form>\n  </div>\n\n  <div class="grid-parent grid-100 last-updated-section">\n    {{#contestMinneapolisMayor.updated}}\n      <div intro="fade">\n        Last updated at {{ contestMinneapolisMayor.updated.format(\'h:mm a\') }}\n      </div>\n    {{/contestMinneapolisMayor.updated}}\n  </div>\n\n  <div class="grid-parent grid-50 tablet-grid-50 mobile-grid-100">\n    <div class="inner-column-left">\n      <div class="contest-minneapolis-mayor dashboard-section">\n        {{#contestMinneapolisMayor}}\n          {{>dashboardContest}}\n        {{/contestMinneapolisMayor}}\n      </div>\n\n      <div class="contest-st-paul-mayor dashboard-section">\n        {{#contestStPaulMayor}}\n          {{>dashboardContest}}\n        {{/contestStPaulMayor}}\n      </div>\n\n      <div class="contest-st-paul-council dashboard-section">\n        {{#contestStPaulCouncil}}\n          {{>dashboardContest}}\n        {{/contestStPaulCouncil}}\n      </div>\n\n      <div class="elections-search dashboard-section">\n        <h4>Other elections</h4>\n\n        <form>\n          <label for="contest-search">Search contests by title or candidate.  Start typing to see suggestions. <br /></label>\n          <input type="text" id="contest-search" placeholder="Search by title or candidate" />\n        </form>\n      </div>\n    </div>\n  </div>\n\n  <div class="grid-parent grid-50 tablet-grid-50 mobile-grid-100">\n    <div class="inner-column-right">\n      <div class="contest-minneapolis-council dashboard-section">\n        <h4 class="title-minneapolis-council">Minneapolis City Council</h4>\n\n        {{#contestMinneapolisCouncil3}}\n          {{>dashboardContest}}\n        {{/contestMinneapolisCouncil3}}\n\n        {{#contestMinneapolisCouncil6}}\n          {{>dashboardContest}}\n        {{/contestMinneapolisCouncil6}}\n\n        {{#contestMinneapolisCouncil10}}\n          {{>dashboardContest}}\n        {{/contestMinneapolisCouncil10}}\n\n        {{#contestMinneapolisCouncil5}}\n          {{>dashboardContest}}\n        {{/contestMinneapolisCouncil5}}\n\n        {{#contestMinneapolisCouncil9}}\n          {{>dashboardContest}}\n        {{/contestMinneapolisCouncil9}}\n\n        {{#contestMinneapolisCouncil12}}\n          {{>dashboardContest}}\n        {{/contestMinneapolisCouncil12}}\n\n        {{#contestMinneapolisCouncil13}}\n          {{>dashboardContest}}\n        {{/contestMinneapolisCouncil13}}\n\n      </div>\n    </div>\n  </div>\n</div>',"template-footnote":'<div class="footnote">\n  <p>Unofficial election data provided by the <a href="http://www.sos.state.mn.us/" target="_blank">MN Secretary of State</a>.  Test data will be provided until 8PM on Election Night.  Some code, techniques, and data on <a href="https://github.com/zzolo/minnpost-elections-dashboard" target="_blank">Github</a>.</p>\n</div>',"template-loading":'<div class="loading-container">\n  <div class="loading"><span>Loading...</span></div>\n</div>'},function(a){_.extend(a.prototype,{defaultOptions:{dataPath:"./data/",jsonpProxy:"http://mp-jsonproxy.herokuapp.com/proxy?url=",electionsAPI:"http://localhost:5000/?q=",electionsAPILocal:"http://localhost:5000/?q=",boundaryAPI:"http://boundaries.minnpost.com/1.0/",boundarySets:["counties-2010","county-commissioner-districts-2012","minneapolis-parks-and-recreation-districts-2014","minor-civil-divisions-2010","school-districts-2013","wards-2012"],mapQuestKey:"Fmjtd%7Cluub2d01ng%2C8g%3Do5-9ua20a",mapQuestQuery:"http://www.mapquestapi.com/geocoding/v1/address?key=[[[KEY]]]&outFormat=json&countrycodes=us&maxResults=1&location=[[[ADDRESS]]]",originalTitle:document.title},start:function(){var a=this,b=["template-application","template-footnote","template-dashboard","template-loading","template-contest","template-contests","template-dashboard-contest"];this.getTemplates(b).done(function(){a.applicationView=new a.ApplicationView({el:a.$el,template:a.template("template-application")}),a.footnoteView=new a.FootnoteView({el:a.$el.find(".footnote-container"),template:a.template("template-footnote")}),a.router=new a.DashboardRouter(_.extend(a.options,{app:a})),a.router.start()})}})}(mpApps["minnpost-elections-dashboard"],jQuery),function(a){a.prototype.ContestModel=Backbone.Model.extend({query:"SELECT r.*, c.* FROM contests AS c LEFT JOIN results AS r ON c.id = r.contest_id WHERE c.id = '%CONTEST_ID%'",contestFields:["id","contest_id","boundary","county_id","district_code","office_id","precinct_id","precincts_reporting","question_body","ranked_choice","results_group","seats","state","title","total_effected_precincts","total_votes_for_office","updated","question_body","question_help"],npParties:["NP","WI"],initialize:function(a,b){this.options=b||{},this.app=b.app,this.on("sync",this.contestUpdate)},url:function(){return this.app.options.electionsAPI+encodeURIComponent(this.query.replace("%CONTEST_ID%",this.id))},parse:function(a){var b=this,c={};if(c.results=[],_.each(a,function(a){var d={};_.each(a,function(a,e){_.indexOf(b.contestFields,e)>=0?c[e]=a:d[e]=a}),c.results.push(d)}),c.ranked_choice){var d={};_.each(c.results,function(a){var b=a.ranked_choice_place;d[a.candidate_id]=d[a.candidate_id]||{},d[a.candidate_id].ranked_choices=d[a.candidate_id].ranked_choices||{},d[a.candidate_id].ranked_choices[b]={ranked_choice:b,percentage:a.percentage,votes_candidate:a.votes_candidate,office_name:a.office_name},1===b&&(d[a.candidate_id]=_.extend(d[a.candidate_id],a)),100===b&&(d[a.candidate_id].percentage=a.percentage,d[a.candidate_id].votes_candidate=a.votes_candidate)}),c.results=_.values(d)}return c.partisan=_.findWhere(c.results,function(a){return _.indexOf(b.npParties,a.party)>=0})?!0:!1,c.results=_.sortBy(c.results,"candidate"),c.results=_.sortBy(c.results,function(a){return-1*a.percentage}),c.precincts_reporting===c.total_effected_precincts&&(c.ranked_choice||(c.results=_.map(c.results,function(a,b){return a.winner=!1,b<c.seats&&(a.winner=!0),a}))),c.updated=moment.unix(c.updated),c},contestUpdate:function(){!this.get("fetchedBoundary")&&_.isString(this.get("boundary"))&&this.fetchBoundary()},fetchBoundary:function(){var a=this;this.app.jsonpRequest({url:this.app.options.boundaryAPI+"boundary/?slug__in="+encodeURIComponent(this.get("boundary"))}).done(function(b){_.isArray(b.objects)&&(a.set("boundarySets",b.objects),a.set("fetchedBoundary",!0))})},connect:function(a){var b=this;this.set("fetchedBoundary",a!==!1?!1:!0),this.fetch(),this.pollID=window.setInterval(function(){b.fetch()},3e4)},disconnect:function(){window.clearInterval(this.pollID)}})}(mpApps["minnpost-elections-dashboard"],jQuery),function(a){a.prototype.ContestsCollection=Backbone.Collection.extend({model:a.prototype.ContestModel,query:"SELECT r.*, c.* FROM contests AS c LEFT JOIN results AS r ON c.id = r.contest_id WHERE (%CONTEST_SEARCH%) ORDER BY c.title, r.percentage, r.candidate ASC LIMIT 400",url:function(){var a=this.options.search.split("|");return a=_.map(a,function(a){return a=a.split(" ").join("%"),a=a.split("+").join("%"),"title LIKE '%"+a+"%'"}),this.app.options.electionsAPI+encodeURIComponent(this.query.replace("%CONTEST_SEARCH%",a.join(" OR ")))},parse:function(a){return _.values(_.groupBy(a,"id"))},initialize:function(a,b){this.options=b||{},this.app=b.app,this.on("add",function(a){a.options=b,a.app=b.app}),this.on("sync",function(){this.contestUpdate()})},contestUpdate:function(){this.fetchedBoundary||this.fetchBoundary()},fetchBoundary:function(){var a=this;this.app.jsonpRequest({url:this.app.options.boundaryAPI+"boundary/?slug__in="+encodeURIComponent(this.pluck("boundary").join(","))}).done(function(b){_.isArray(b.objects)&&(_.each(b.objects,function(b){a.filter(function(a){return a.get("boundary").indexOf(b.slug)>=0})[0].set("boundarySets",[b])}),a.fetchedBoundary=!0,a.each(function(a){a.set("fetchedBoundary",!0)}))})},connect:function(){var a=this;this.fetch(),this.pollID=window.setInterval(function(){a.fetch()},3e4)},disconnect:function(){window.clearInterval(this.pollID)}}),a.prototype.ContestsLocationCollection=a.prototype.ContestsCollection.extend({query:"SELECT r.*, c.* FROM contests AS c LEFT JOIN results AS r ON c.id = r.contest_id WHERE boundary IN (%CONTEST_SEARCH%) ORDER BY  c.title, r.percentage, r.candidate ASC LIMIT 400",url:function(){return this.app.options.electionsAPI+encodeURIComponent(this.query.replace("%CONTEST_SEARCH%","'"+this.boundaries.join("','")+"'"))},initialize:function(){a.prototype.ContestsLocationCollection.__super__.initialize.apply(this,arguments),this.on("fetchedBoundary",function(){this.connect()})},contestUpdate:function(){this.matchedBoundary||this.matchBoundary()},matchBoundary:function(){var a=this;_.each(this.fullBoundaries,function(b){_.each(a.where({boundary:b.slug}),function(a){a.set("boundarySets",[b])})}),this.each(function(a){a.set("fetchedBoundary",!0)}),this.matchedBoundary=!0},fetchBoundaryFromCoordinates:function(){var a=this;this.app.jsonpRequest({url:this.app.options.boundaryAPI+"boundary/?contains="+encodeURIComponent(this.options.lonlat[1])+","+encodeURIComponent(this.options.lonlat[0])+"&sets="+encodeURIComponent(this.app.options.boundarySets.join(","))}).done(function(b){_.isArray(b.objects)&&(a.fullBoundaries=b.objects,a.boundaries=_.pluck(b.objects,"slug"),a.trigger("fetchedBoundary"))})}})}(mpApps["minnpost-elections-dashboard"],jQuery),function(a,b){a.prototype.ApplicationView=Ractive.extend({init:function(){}}),a.prototype.FootnoteView=Ractive.extend({init:function(){}}),a.prototype.ContestBaseView=Ractive.extend({makeMap:function(a,b){var c,d,e,f={};b=_.isArray(b)?b:[b],b=_.filter(b,function(a){return _.isUndefined(f[a.slug])?(f[a.slug]=!0,!0):!1}),d=_.map(b,function(a){return a.simple_shape}),e=new L.Map(a,{zoom:10,center:[44.98,-93.2636],scrollWheelZoom:!1,trackResize:!0}),e.attributionControl.setPrefix(!1),e.addLayer(new L.tileLayer("//{s}.tiles.mapbox.com/v3/minnpost.map-wi88b700/{z}/{x}/{y}.png")),c=new L.featureGroup,_.each(d,function(a){var b=new L.geoJson(a);b.setStyle({stroke:!0,color:"#2DA51D",weight:1.5,opacity:.9,fill:!0,fillColor:"#2DA51D",fillOpacity:.2,clickable:!1}),c.addLayer(b)}),e.addLayer(c),window.setTimeout(function(){e.fitBounds(c.getBounds())},500)},observeTitle:function(a){this.observe("title",function(b){b&&(document.title=a?b+" | "+a:b)})}}),a.prototype.DashboardView=a.prototype.ContestBaseView.extend({init:function(a){var c,d=this,e=b(this.el).find("#contest-search");this.app=a.app,c=this.app.options.electionsAPI+"SELECT c.id AS id, title AS title "+"FROM contests AS c WHERE "+"c.title LIKE '%%QUERY%' "+"UNION "+"SELECT c.id AS id, "+"r.candidate || ' (' || c.title || ')' AS title "+"FROM results AS r "+"JOIN contests AS c ON r.contest_id = c.id "+"WHERE r.candidate LIKE '%%QUERY%' ORDER BY title LIMIT 20 ",this.set("fNum",_.formatNumber),e.typeahead({name:"Contests and Candidates",remote:{url:c,dataType:"jsonp",jsonpCallback:"mpServerSideCachingHelper",replace:function(a,b){var c=decodeURIComponent(b);return c=c.replace(new RegExp(" ","g"),"%"),encodeURI(a.replace(new RegExp(this.wildcard,"g"),c))}},valueKey:"title"}),e.on("typeahead:selected",function(a,b){d.app.router.navigate("/contest/"+b.id,{trigger:!0})}),this.on("teardown",function(){e.typeahead("destroy")}),this.set("geolocationEnabled",_.isObject(navigator)&&_.isObject(navigator.geolocation))}}),a.prototype.ContestView=a.prototype.ContestBaseView.extend({init:function(){this.set("classes","contest-view"),this.set("fNum",_.formatNumber),this.observe("boundarySets",function(a){_.isArray(a)&&_.isObject(a[0])&&this.makeMap("contest-map-"+this.get("id"),a)})}}),a.prototype.ContestsView=a.prototype.ContestBaseView.extend({init:function(){var a=this;this.set("fNum",_.formatNumber),this.observe("models.0.fetchedBoundary",function(){var b=this.get("models.0.boundarySets");_.isArray(b)&&_.isObject(b[0])&&_.each(this.get("models"),function(b){a.makeMap("contest-map-"+b.get("id"),b.get("boundarySets"))})})}})}(mpApps["minnpost-elections-dashboard"],jQuery),function(a,b){a.prototype.DashboardRouter=Backbone.Router.extend({initialize:function(a){this.options=a,this.app=a.app},routes:{dashboard:"routeDashboard","search/:term":"routeSearch","contest/:contest":"routeContest","location(/:place)":"routeLocation","*default":"routeDefault"},start:function(){Backbone.history.start()},routeDefault:function(){this.navigate("/dashboard",{trigger:!0,replace:!0})},routeDashboard:function(){var a=this,c={};this.teardownObjects(),this.app.dashboardContests={contestMinneapolisMayor:"id-MN---43000-2001",contestMinneapolisCouncil3:"id-MN---43000-2121",contestMinneapolisCouncil6:"id-MN---43000-2151",contestMinneapolisCouncil10:"id-MN---43000-2191",contestMinneapolisCouncil5:"id-MN---43000-2141",contestMinneapolisCouncil9:"id-MN---43000-2181",contestMinneapolisCouncil12:"id-MN---43000-2211",contestMinneapolisCouncil13:"id-MN---43000-2221",contestStPaulMayor:"id-MN---58000-2001",contestStPaulCouncil:"id-MN---58000-2101"},_.each(this.app.dashboardContests,function(b,d){a.app[d]=new a.app.ContestModel({id:b},{app:a.app}),a.app[d].connect(!1),c[d]=a.app[d]}),c.contestMinneapolisMayor.set("rows",8),c.contestStPaulMayor.set("rows",3),c.title="Dashboard",this.app.dashboardView=new this.app.DashboardView({el:this.app.$el.find(".content-container"),template:this.app.template("template-dashboard"),data:c,app:this.app,partials:{dashboardContest:this.app.template("template-dashboard-contest"),loading:this.app.template("template-loading")},adaptors:["Backbone"]}),this.app.dashboardView.on("addresssSearch",function(c){c.original.preventDefault(),a.navigate("/location/"+b(this.el).find("#address-search").val(),{trigger:!0})}),this.app.dashboardView.observeTitle(this.app.options.originalTitle),this.reFocus()},routeSearch:function(a){this.teardownObjects(),this.app.contestsSearch=new this.app.ContestsCollection([],{app:this.app,search:a}),this.app.contestsSearch.connect(),this.app.contestsSearchView=new this.app.ContestsView({el:this.app.$el.find(".content-container"),template:this.app.template("template-contests"),data:{models:this.app.contestsSearch,title:"Search: "+a},partials:{contest:this.app.template("template-contest"),loading:this.app.template("template-loading")},adaptors:["Backbone"]}),this.app.contestsSearchView.observeTitle(this.app.options.originalTitle),this.reFocus()},routeContest:function(a){this.teardownObjects(),this.app.contest=new this.app.ContestModel({id:a},{app:this.app}),this.app.contest.connect(),this.app.contestView=new this.app.ContestView({el:this.app.$el.find(".content-container"),template:this.app.template("template-contest"),data:this.app.contest,partials:{loading:this.app.template("template-loading")},adaptors:["Backbone"]}),this.app.contestView.observeTitle(this.app.options.originalTitle),this.reFocus()},routeLocation:function(a){function b(b){c.app.locationContests=new c.app.ContestsLocationCollection([],{app:c.app,lonlat:b}),c.app.locationContests.fetchBoundaryFromCoordinates(),c.app.contestsLocationView=new c.app.ContestsView({el:c.app.$el.find(".content-container"),template:c.app.template("template-contests"),data:{models:c.app.locationContests,title:a?"Contests for "+a:"Contests for your location"},partials:{contest:c.app.template("template-contest"),loading:c.app.template("template-loading")},adaptors:["Backbone"]}),c.app.contestsLocationView.observeTitle(c.app.options.originalTitle),c.reFocus()}var c=this;this.teardownObjects(),a?/[a-zA-Z]+/.test(a)||_.isNaN(parseFloat(a.split(",")[0]))||_.isNaN(parseFloat(a.split(",")[1]))?this.addressLocate(a).done(function(a){b(a)}):b([parseFloat(a.split(",")[0]),parseFloat(a.split(",")[1])]):this.geolocate().done(function(a){b(a)})},geolocate:function(){var a=this,c=b.Deferred();return navigator.geolocation.getCurrentPosition(function(b){c.resolveWith(a,[[b.coords.longitude,b.coords.latitude]])},function(){c.rejectWith(a,[{message:"Issue retrieving current position."}])}),c.promise()},addressLocate:function(a){var c=this,d=b.Deferred(),e=this.app.options.mapQuestQuery.replace("[[[KEY]]]",this.app.options.mapQuestKey).replace("[[[ADDRESS]]]",encodeURIComponent(a));return b.ajax({dataType:"jsonp",url:e}).done(function(a){var b;_.size(a.results[0].locations)>0&&_.isObject(a.results[0].locations[0].latLng)?(b=a.results[0].locations[0].latLng,d.resolveWith(c,[[b.lng,b.lat]])):d.rejectWith(c,[{message:"Issue retrieving position from address."}])}).fail(function(){d.rejectWith(c,arguments)}),d.promise()},reFocus:function(){this.viewed&&b("html, body").animate({scrollTop:this.app.$el.offset().top-5},750),this.viewed=!0},teardownObjects:function(){var a=this,b=["contestView","contestsSearchView","contestsLocationView"],c=["contest","contestsSearch","locationContests"];_.isObject(this.app.dashboardContests)&&(c=_.union(c,_.keys(this.app.dashboardContests))),_.each(c,function(b){_.isObject(a.app[b])&&(a.app[b].stopListening(),a.app[b].disconnect())}),_.each(b,function(b){_.isObject(a.app[b])&&(_.isObject(a.app[b].map),a.app[b].teardown())})}})}(mpApps["minnpost-elections-dashboard"],jQuery);